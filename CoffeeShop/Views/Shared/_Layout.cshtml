@using CoffeeShop.Models
@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject IHttpContextAccessor HttpContextAccessor
@inject CoffeeShop.Data.CoffeeShopDbContext DbContext

@{
    var cartCount = HttpContextAccessor?.HttpContext?.Session.GetInt32("CartCount") ?? 0;
    var unreadCount = DbContext.ContactMessages.Count(m => !m.IsRead);
}

<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Site made with Coffee Shop v5.7 -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="generator" content="Mobirise v5.7.8, mobirise.com">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
    <link rel="shortcut icon" href="~/images/coffee-icon-sign-symbol-design-free-png.webp" type="image/x-icon">
    <meta name="description" content="">

    <title>Home</title>
    <link rel="stylesheet" href="~/web/assets/mobirise-icons2/mobirise2.css">
    <link rel="stylesheet" href="~/web/assets/mobirise-icons-bold/mobirise-icons-bold.css">
    <link rel="stylesheet" href="~/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/bootstrap/css/bootstrap-grid.min.css">
    <link rel="stylesheet" href="~/bootstrap/css/bootstrap-reboot.min.css">
    <link rel="stylesheet" href="~/parallax/jarallax.css">
    <link rel="stylesheet" href="~/dropdown/css/style.css">
    <link rel="stylesheet" href="~/socicon/css/styles.css">
    <link rel="stylesheet" href="~/theme/css/style.css">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Jost:100,200,300,400,500,600,700,800,900,100i,200i,300i,400i,500i,600i,700i,800i,900i&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Jost:100,200,300,400,500,600,700,800,900,100i,200i,300i,400i,500i,600i,700i,800i,900i&display=swap">
    </noscript>
    <link rel="preload" as="style" href="~/mobirise/css/mbr-additional.css">
    <link rel="stylesheet" href="~/mobirise/css/mbr-additional.css" type="text/css">
</head>
<body>
    <section data-bs-version="5.1" class="menu menu3 cid-tsEQosCCDP" once="menu" id="menu3-0">
        <nav class="navbar navbar-dropdown navbar-fixed-top navbar-expand-lg">
            <div class="container">
                <div class="navbar-brand">
                    <span class="navbar-logo">
                        <a asp-controller="Home" asp-action="Index">
                            <img src="~/images/coffee-icon-sign-symbol-design-free-png.webp" alt="Coffee Shop" style="height: 3rem;">
                        </a>
                    </span>
                </div>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbarSupportedContent" data-bs-target="#navbarSupportedContent" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <div class="hamburger">
                        <span></span>
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav nav-dropdown nav-right" data-app-modern-menu="true">
                        <li class="nav-item">
                            <a class="nav-link link text-black show display-4" asp-controller="Home" asp-action="Index">Home</a>
                        </li>

                        @if (!User.IsInRole("Admin"))
                        {
                            <li class="nav-item">
                                <a class="nav-link link text-black show display-4" asp-controller="Products" asp-action="Shop">Shop</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link link text-black show display-4" asp-page="/Contact">Contact Us</a>
                            </li>
                        }
                        @if (SignInManager.IsSignedIn(User) && !User.IsInRole("Admin"))
                        {
                            <li class="nav-item">
                                <a class="nav-link link text-black show display-4" asp-page="/OrderHistory">Order History</a>
                            </li>
                        }
                        else if (SignInManager.IsSignedIn(User) && User.IsInRole("Admin"))
                        {
                            <li class="nav-item">
                                <a class="nav-link link text-black show display-4" asp-page="/Admin/Orders">Orders</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link link text-black show display-4" asp-page="/Admin/ManageProducts">Manage Products</a>
                            </li>
                        }

                        @if (SignInManager.IsSignedIn(User))
                        {
                            <li class="nav-item">
                                <button id="logoutBtn" class="nav-link link text-black show display-4" type="button" style="background:none;border:none;padding:0;">
                                    Logout
                                </button>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item">
                                <a class="nav-link link text-black show display-4" asp-area="Identity" asp-page="/Account/Login">Login</a>
                            </li>
                        }

                        <partial name="_LoginPartial"></partial>

                        @if (!User.IsInRole("Admin"))
                        {
                            <li class="nav-item">
                                <a class="nav-link link text-black show display-4" asp-controller="ShoppingCart" asp-action="Index">
                                    <span class="mobi-mbri mobi-mbri-shopping-bag mbr-iconfont mbr-iconfont-btn">
                                        <small>(@cartCount)</small>
                                    </span>
                                </a>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item d-flex align-items-center" style="margin-left: 8px;">
                                <a class="nav-link position-relative p-0" asp-page="/Admin/ContactNotifications" title="Contact Notifications" style="display: flex; align-items: center; height: 40px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" stroke="#2d295c" stroke-width="2" viewBox="0 0 24 24" style="display: block;">
                                        <path d="M18 16v-5a6 6 0 10-12 0v5a2 2 0 01-2 2h16a2 2 0 01-2-2z" />
                                        <circle cx="12" cy="20" r="2" />
                                    </svg>
                                    @if (unreadCount > 0)
                                    {
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.7rem;">
                                            @unreadCount
                                        </span>
                                    }
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </section>

@RenderBody()

    <div id="logoutModal" class="modal" tabindex="-1" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:2rem;border-radius:8px;text-align:center;">
            <span>Logging out...</span>
        </div>
    </div>

    <script src="~/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="~/parallax/jarallax.js"></script>
    <script src="~/smoothscroll/smooth-scroll.js"></script>
    <script src="~/ytplayer/index.js"></script>
    <script src="~/dropdown/js/navbar-dropdown.js"></script>
    <script src="~/theme/js/script.js"></script>

@await RenderSectionAsync("Scripts", false)

    <script>
            document.getElementById('logoutBtn')?.addEventListener('click', function () {
                var modal = document.getElementById('logoutModal');
                modal.style.display = 'flex';

                fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                })
                .then(response => response.json())
                .then(data => {
                    setTimeout(function () {
                        window.location.href = '/';
                    }, 2000);
                })
                .catch(() => {
                    alert('Logout failed. Please try again.');
                    document.getElementById('logoutModal').style.display = 'none';
                });
            });
    </script>

    @Html.AntiForgeryToken()
</body>
</html>